var classifications=[],chart_data=null,current_data="",current_settings=null;function getNumberFormat(){var e=$("#number_format").val();return"none"===e?{multiplier:1,prefix:"",suffix:"",min:"",max:""}:"percent"===e?{multiplier:1,prefix:"",suffix:"%",min:0,max:100}:"other"===e?{multiplier:1,prefix:$("#number_format_prefix").val(),suffix:$("#number_format_suffix").val(),min:$("#number_format_min").val(),max:$("#number_format_max").val()}:void 0}function getTips(){var e=validateChart(chart_data);if(0!==e.length)return e;var t=checkRequiredFields();if(0!==t.length)return t;var a=getEthnicityColumnHeader(),n=getSecondaryColumnHeader();return validateData(chart_data,a,n)}$(document).ready(function(){function r(t){var e=$("#data_text_area").val();0<(chart_data=textToData(e)).length&&(message=chart_data.length-1+" rows by "+chart_data[0].length+" columns"),document.getElementById("data-description").innerHTML=message,function(e){var t=i(e,"[None]"),a=i(e,"Please select");document.getElementById("line__x-axis_column").innerHTML=a,document.getElementById("grouped-bar__bar_column").innerHTML=a,document.getElementById("grouped-bar__groups_column").innerHTML=a,document.getElementById("component__bar_column").innerHTML=a,document.getElementById("component__bar_order").innerHTML=t,document.getElementById("component__section_column").innerHTML=a,document.getElementById("component__section_order").innerHTML=t,document.getElementById("panel-bar__panel_column").innerHTML=a,document.getElementById("panel-bar__panel_order").innerHTML=t,document.getElementById("panel-bar__bar_column").innerHTML=a,document.getElementById("panel-bar__bar_order").innerHTML=t,document.getElementById("panel-line__x-axis_column").innerHTML=a}(chart_data[0]);var a=n(chart_data);$.ajax({type:"post",url:url_get_classifications,dataType:"json",data:JSON.stringify({data:a}),contentType:"application/json; charset=utf-8",success:function(e){(function(e){var t="";for(var a in e){var n=e[a].classification.name,r=e[a].classification.id;t=0===a?t+'<option value="'+r+'" selected>'+n+"</option>":t+'<option value="'+r+'" >'+n+"</option>"}document.getElementById("ethnicity_settings").innerHTML=t})(classifications=e.classifications),o(),document.getElementById("ethnicity_settings_section").classList.remove("hidden"),document.getElementById("select_chart_type").classList.remove("hidden"),t&&t()},failure:function(){console.log("failed to get ethnicity classifcations")},error:function(e){console.log(e)}})}function n(e){var t=_.clone(e),a=function(e){for(var t=0;t<e.length;t++){if(0<=e[t].toLowerCase().trim().indexOf("ethnic"))return t}return-1}(t.shift());return 0<=a?_.pluck(t,a):[]}function o(){"custom"===$("#ethnicity_settings").val()?document.getElementById("custom_classification__panel").classList.remove("hidden"):document.getElementById("custom_classification__panel").classList.add("hidden")}function i(e,t){var a='<option value="'+t+'" selected>'+t+"</option>",n=function(e){var t=["Measure","Ethnicity","Ethnic group","Value","Values"],a=[];for(h in e){var n=e[h];t.indexOf(n)<0&&a.push(n)}return a}(e);for(var r in n){var o=n[r];a=a+'<option value="'+o+'">'+o+"</option>"}return a}function l(e){hideErrors();var t=getTips();0<t.length?function(e){document.getElementById("preview_container").classList.add("hidden"),document.getElementById("errors_container").classList.remove("hidden");for(var t=document.getElementById("tip-list"),a=0;a<t.children.length;a++)t.children[a].classList.add("hidden");0<s(e,ETHNICITY_ERROR).length&&(document.getElementById("tip__ethnicity-column").classList.remove("hidden"),document.getElementById("tab_seperated_content").classList.add("govuk-form-group--error"),document.getElementById("edit-data-error").classList.remove("hidden"));0<s(e,VALUE_ERROR).length&&(document.getElementById("tip__value-column").classList.remove("hidden"),document.getElementById("tab_seperated_content").classList.add("govuk-form-group--error"),document.getElementById("edit-data-error").classList.remove("hidden"));0<s(e,RECTANGLE_ERROR).length&&(document.getElementById("tip__rectangular-data").classList.remove("hidden"),document.getElementById("tab_seperated_content").classList.add("govuk-form-group--error"),document.getElementById("edit-data-error").classList.remove("hidden"));0<s(e,DATA_ERROR_COMPLEX_DATA).length&&(document.getElementById("tip__complex-data").classList.remove("hidden"),document.getElementById("select_chart_type").classList.add("govuk-form-group--error"),document.getElementById("chart_type_selector-error").classList.remove("hidden"));0<s(e,DATA_ERROR_DUPLICATION).length&&(document.getElementById("tip__duplicate-data").classList.remove("hidden"),document.getElementById("tab_seperated_content").classList.add("govuk-form-group--error"),document.getElementById("edit-data-error").classList.remove("hidden"));0<s(e,DATA_ERROR_MISSING_DATA).length&&document.getElementById("tip__missing-data").classList.remove("hidden");if(0<s(e,MISSING_FIELD_ERROR).length){document.getElementById("tip__required-settings").classList.remove("hidden"),document.getElementById("settings-error-anchor-link").href="#"+e[0].field+"-error";var n=document.getElementById(e[0].field+"-error");n&&(n.classList.remove("hidden"),n.closest(".chart-builder-section").classList.add("govuk-form-group--error"))}}(t):function(){document.getElementById("preview_container").classList.remove("hidden");var e=v();e&&(e.title="",drawChart("container",e),document.getElementById("save_section").classList.remove("hidden"));document.getElementById("chart_title").dispatchEvent(new Event("input"))}()}function s(e,t){return _.filter(e,function(e){return e.errorType===t})}function d(){var e=$("#data_text_area").val(),t=$("#chart_type_selector").val();return{data:textToData(e),type:t,preset:m(),custom:p(),chartOptions:function(e){switch(e){case"bar_chart":return{};case"line_graph":return{x_axis_column:$("#line__x-axis_column").val()};case"grouped_bar_chart":return"ethnicity_as_group"===(t=$("#grouped-bar__data_style").val())?{data_style:t,bar_column:$("#grouped-bar__bar_column").val()}:{data_style:t,group_column:$("#grouped-bar__groups_column").val()};case"component_chart":return"ethnicity_as_sections"===(t=$("#component__data_style").val())?{data_style:t,bar_column:$("#component__bar_column").val(),bar_order:$("#component__bar_order").val()}:{data_style:t,section_column:$("#component__section_column").val(),section_order:$("#component__section_order").val()};case"panel_bar_chart":var t;return"ethnicity_as_panels"===(t=$("#panel-bar__data_style").val())?{data_style:t,bar_column:$("#panel-bar__bar_column").val(),bar_order:$("#panel-bar__bar_order").val()}:{data_style:t,panel_column:$("#panel-bar__panel_column").val(),panel_order:$("#panel-bar__panel_order").val()};case"panel_line_chart":return{x_axis_column:$("#panel-line__x-axis_column").val()};default:return{}}}(t),chartFormat:{chart_title:$("#chart_title").val(),x_axis_label:$("#x_axis_label").val(),y_axis_label:$("#y_axis_label").val(),number_format:$("#number_format").val(),number_format_prefix:$("#number_format_prefix").val(),number_format_suffix:$("#number_format_suffix").val(),number_format_min:$("#number_format_min").val(),number_format_max:$("#number_format_max").val()}}}function m(){return $("#ethnicity_settings").val()}function u(){return $("#custom_classification__selector").val()}function p(){return{code:u(),hasParents:$("#custom_classification__has_parents").prop("checked"),hasAll:$("#custom_classification__has_all").prop("checked"),hasUnknown:$("#custom_classification__has_unknown").prop("checked")}}function v(){var e=$("#chart_type_selector").val(),t=null,a=function(e){for(c in classifications)if(classifications[c].classification.id===e)return classifications[c];return null}($("#ethnicity_settings").val());if("bar_chart"===e)t=barchartObject(g(a,chart_data,["value"]),"Ethnicity","[None]","Ethnicity-parent","Ethnicity-order",$("#chart_title").val(),$("#x_axis_label").val(),$("#y_axis_label").val(),getNumberFormat());else if("line_graph"===e){var n=$("#line__x-axis_column").val();t=linechartObject(g(a,chart_data,["value",n]),n,"Ethnicity",$("#chart_title").val(),$("#x_axis_label").val(),$("#y_axis_label").val(),getNumberFormat(),"Ethnicity-order")}else if("grouped_bar_chart"===e)if("ethnicity_as_group"===$("#grouped-bar__data_style").val()){var r=$("#grouped-bar__bar_column").val();t=barchartObject(g(a,chart_data,["value",r]),"Ethnicity",r,"[None]","Ethnicity-order",$("#chart_title").val(),$("#x_axis_label").val(),$("#y_axis_label").val(),getNumberFormat())}else{var o=$("#grouped-bar__groups_column").val();t=barchartObject(g(a,chart_data,["value",o]),o,"Ethnicity","[None]","Ethnicity-order",$("#chart_title").val(),$("#x_axis_label").val(),$("#y_axis_label").val(),getNumberFormat())}else if("component_chart"===e)if("ethnicity_as_bar"===$("#component__data_style").val()){var _=$("#component__section_column").val(),i=$("#component__section_order").val(),l=[];l=g(a,chart_data,i&&"[None]"!==i?["value",_,i]:["value",_]),t=componentChartObject(l,"Ethnicity",_,$("#chart_title").val(),$("#x_axis_label").val(),$("#y_axis_label").val(),getNumberFormat(),"Ethnicity-order",i)}else{o=$("#component__bar_column").val();var s=$("#component__bar_order").val();l=[];l=g(a,chart_data,s&&"[None]"!==s?["value",o,s]:["value",o]),t=componentChartObject(g(a,chart_data,["value",o]),o,"Ethnicity",$("#chart_title").val(),$("#x_axis_label").val(),$("#y_axis_label").val(),getNumberFormat(),s,"Ethnicity-order")}else if("panel_bar_chart"===e)if("ethnicity_as_panel_bars"===$("#panel-bar__data_style").val()){var d=$("#panel-bar__panel_column").val(),m=$("#panel-bar__panel_order").val();l=[];l=g(a,chart_data,m&&"[None]"!==m?["value",d,m]:["value",d]),t=panelBarchartObject(l,"Ethnicity",d,$("#chart_title").val(),"","",getNumberFormat(),"Ethnicity-order",m)}else{var u=$("#panel-bar__bar_column").val(),h=$("#panel-bar__bar_order").val();l=[];l=g(a,chart_data,u&&"[None]"!==h?["value",u,h]:["value",u]),t=panelBarchartObject(l,u,"Ethnicity",$("#chart_title").val(),"","",getNumberFormat(),h,"Ethnicity-order")}else if("panel_line_chart"===e){var p=$("#panel-line__x-axis_column").val();l=g(a,chart_data,["value",p]);t=panelLinechartObject(l,p,"Ethnicity",$("#chart_title").val(),"","",getNumberFormat(),"Ethnicity-order")}return t}function g(e,t,a){var n=[["Ethnicity","Ethnicity-parent","Ethnicity-order"].concat(a)],r=_.clone(t),o=r.shift(),c=_.map(o,function(e){return e.toLowerCase().trim()}),i=_.map(a,function(e){var t=e.toLowerCase().trim();return c.indexOf(t)});for(var l in e.data){var s=e.data[l],d=[s.display_value,s.parent,s.order];d=d.concat(_.map(i,function(e){return-1===e?"":r[l][e]})),n=n.concat([d])}return n}function y(e){$("#chart_type_selector").val(e);for(var t=document.getElementsByClassName("chart-option-group"),a=0;a<t.length;a++)t[a].classList.add("hidden");"none"!==e&&(document.getElementById(e+"_options").classList.remove("hidden"),document.getElementById("chart_format_options").classList.remove("hidden"))}function b(e){!function(e){$("#custom_classification__selector").val(e)}(e.code),function(e){$("#custom_classification__has_parents").prop("checked",e)}(e.hasParents),function(e){$("#custom_classification__has_all").prop("checked",e)}(e.hasAll),function(e){$("#custom_classification__has_unknown").prop("checked",e)}(e.hasUnknown)}function f(e){switch($("#chart_type_selector").val(e.type),y(e.type),e.preset&&function(e){$("#ethnicity_settings").val(e)}(e.preset),e.custom&&b(e.custom),o(),$("#chart_title").val(e.chartFormat.chart_title),e.type){case"line_graph":var t=e.chartOptions.x_axis_column;$("#line__x-axis_column").val(t);break;case"grouped_bar_chart":var a=e.chartOptions.data_style;$("#grouped-bar__data_style").val(a),"ethnicity_as_group"===a?($("#grouped-bar__bar_column").val(e.chartOptions.bar_column),document.getElementById("grouped-bar__ethnicity_is_group").classList.remove("hidden"),document.getElementById("grouped-bar__ethnicity_is_bar").classList.add("hidden")):($("#grouped-bar__groups_column").val(e.chartOptions.group_column),document.getElementById("grouped-bar__ethnicity_is_group").classList.add("hidden"),document.getElementById("grouped-bar__ethnicity_is_bar").classList.remove("hidden"));break;case"component_chart":a=e.chartOptions.data_style;$("#component__data_style").val(a),"ethnicity_as_sections"===a?($("#component__bar_column").val(e.chartOptions.bar_column),$("#component__bar_order").val(e.chartOptions.bar_order),document.getElementById("component__ethnicity_is_sections").classList.remove("hidden"),document.getElementById("component__ethnicity_is_bar").classList.add("hidden")):($("#component__section_column").val(e.chartOptions.section_column),$("#component__section_order").val(e.chartOptions.section_order),document.getElementById("component__ethnicity_is_sections").classList.add("hidden"),document.getElementById("component__ethnicity_is_bar").classList.remove("hidden"));break;case"panel_bar_chart":a=e.chartOptions.data_style;$("#panel-bar__data_style").val(a),"ethnicity_as_panels"===a?($("#panel-bar__bar_column").val(e.chartOptions.bar_column),$("#panel-bar__bar_order").val(e.chartOptions.bar_order),document.getElementById("panel-bar__ethnicity_as_bar").classList.add("hidden"),document.getElementById("panel-bar__ethnicity_as_panels").classList.remove("hidden")):($("#panel-bar__panel_column").val(e.chartOptions.panel_column),$("#panel-bar__panel_order").val(e.chartOptions.panel_order),document.getElementById("panel-bar__ethnicity_as_bar").classList.remove("hidden"),document.getElementById("panel-bar__ethnicity_as_panels").classList.add("hidden"));break;case"panel_line_chart":t=e.chartOptions.x_axis_column;$("#panel-line__x-axis_column").val(t)}$("#number_format").val(e.chartFormat.number_format),$("#number_format_prefix").val(e.chartFormat.number_format_prefix),$("#number_format_suffix").val(e.chartFormat.number_format_suffix),$("#number_format_min").val(e.chartFormat.number_format_min),$("#number_format_max").val(e.chartFormat.number_format_max),"other"===e.chartFormat.number_format&&document.getElementById("other_number_format").classList.remove("hidden")}document.getElementById("confirm-data").addEventListener("click",function(e){var t=document.getElementById("data_text_area"),a=document.getElementById("data-error"),n=document.getElementById("data-form-group");""!=t.value?(r(function(){current_settings&&f(current_settings),l()}),document.getElementById("data-panel").classList.add("hidden"),document.getElementById("edit-panel").classList.remove("hidden"),document.getElementById("builder-title").textContent="Format and view chart",document.title="Format and view chart",t.classList.remove("govuk-textarea--error"),n.classList.remove("govuk-form-group--error"),a.textContent=""):(t.classList.add("govuk-textarea--error"),n.classList.add("govuk-form-group--error"),a.textContent="Enter some data",a.classList.remove("hidden"),document.getElementById("errors_container").classList.remove("hidden"),document.getElementById("data-missing").classList.remove("hidden"))}),document.getElementById("edit-data").addEventListener("click",function(e){hideErrors(),current_data=$("#data_text_area").val(),current_settings=d(),document.getElementById("data-panel").classList.remove("hidden"),document.getElementById("edit-panel").classList.add("hidden"),document.getElementById("builder-title").textContent="Create a chart",document.title="Create a chart"}),document.getElementById("cancel-edit-data").addEventListener("click",function(e){$("#data_text_area").val(current_data),document.getElementById("data-panel").classList.add("hidden"),document.getElementById("edit-panel").classList.remove("hidden"),document.getElementById("builder-title").textContent="Format and view chart",document.title="Format and view chart",document.getElementById("errors_container").classList.add("hidden"),document.getElementById("data-missing").classList.add("hidden")}),document.getElementById("save").addEventListener("click",function(e){$("#save").attr("disabled","disabled");var t=v(),a=d();t&&function(e,t){e&&($.each(e.series,function(){for(var e=0;e<this.data.length;e++)isNaN(this.data[e].y)&&(this.data[e].y=0)}),$.ajax({type:"POST",url:url_save_chart_to_page,dataType:"json",data:JSON.stringify({chartObject:e,source:t,classificationCode:m(),customClassificationCode:u(),customClassification:p(),ethnicityValues:n(chart_data)}),contentType:"application/json",success:function(){document.getElementById("breadcrumb").scrollIntoView(),location.reload()}}))}(t,a)}),$("#ethnicity_settings").change(function(){o(),l()}),$("#custom_classification__selector").change(l),$("#chart_type_selector").change(function(){y($(this).val()),l()}),$("#line__x-axis_column").change(l),$("#grouped-bar__data_style").change(function(){"ethnicity_as_group"===$(this).val()?(document.getElementById("grouped-bar__ethnicity_is_group").classList.remove("hidden"),document.getElementById("grouped-bar__ethnicity_is_bar").classList.add("hidden")):(document.getElementById("grouped-bar__ethnicity_is_group").classList.add("hidden"),document.getElementById("grouped-bar__ethnicity_is_bar").classList.remove("hidden")),l()}),$("#grouped-bar__bar_column").change(l),$("#grouped-bar__bar_order").change(l),$("#grouped-bar__groups_column").change(l),$("#grouped-bar__groups_order").change(l),$("#component__data_style").change(function(){"ethnicity_as_bar"===$(this).val()?(document.getElementById("component__ethnicity_is_bar").classList.remove("hidden"),document.getElementById("component__ethnicity_is_sections").classList.add("hidden")):(document.getElementById("component__ethnicity_is_bar").classList.add("hidden"),document.getElementById("component__ethnicity_is_sections").classList.remove("hidden")),l()}),$("#component__section_column").change(l),$("#component__section_order").change(l),$("#component__bar_column").change(l),$("#component__bar_order").change(l),$("#panel-bar__data_style").change(function(){"ethnicity_as_panel_bars"===$(this).val()?(document.getElementById("panel-bar__ethnicity_as_bar").classList.remove("hidden"),document.getElementById("panel-bar__ethnicity_as_panels").classList.add("hidden")):(document.getElementById("panel-bar__ethnicity_as_bar").classList.add("hidden"),document.getElementById("panel-bar__ethnicity_as_panels").classList.remove("hidden")),l()}),$("#panel-bar__bar_column").change(l),$("#panel-bar__bar_order").change(l),$("#panel-bar__panel_column").change(l),$("#panel-bar__panel_order").change(l),$("#panel-line__x-axis_column").change(l),$("#number_format").change(function(){"other"===$(this).val()?document.getElementById("other_number_format").classList.remove("hidden"):document.getElementById("other_number_format").classList.add("hidden"),l()}),function(){if(settings.data){var e=_.map(settings.data,function(e){return e.join("\t")}).join("\n");$("#data_text_area").val(e),r(function(){document.getElementById("data-panel").classList.add("hidden"),document.getElementById("edit-panel").classList.remove("hidden"),f(settings),l()})}}()});var MISSING_FIELD_ERROR="Missing field error";function checkRequiredFields(){if("custom"===$("#ethnicity_settings").val()&&"Please select"===$("#custom_classification__selector").val())return[{errorType:MISSING_FIELD_ERROR,field:"custom_classification__selector"}];switch($("#chart_type_selector").val()){case"bar_chart":return[];case"line_graph":if("Please select"===$("#line__x-axis_column").val())return[{errorType:MISSING_FIELD_ERROR,field:"line__x-axis_column"}];break;case"grouped_bar_chart":if("ethnicity_as_group"===$("#grouped-bar__data_style").val()){if("Please select"===$("#grouped-bar__bar_column").val())return[{errorType:MISSING_FIELD_ERROR,field:"grouped-bar__bar_column"}]}else if("Please select"===$("#grouped-bar__groups_column").val())return[{errorType:MISSING_FIELD_ERROR,field:"grouped-bar__groups_column"}];break;case"component_chart":if("ethnicity_as_sections"===$("#component__data_style").val()){if("Please select"===$("#component__bar_column").val())return[{errorType:MISSING_FIELD_ERROR,field:"component__bar_column"}]}else if("Please select"===$("#component__section_column").val())return[{errorType:MISSING_FIELD_ERROR,field:"component__section_column"}];break;case"panel_bar_chart":if("ethnicity_as_panels"===$("#panel-bar__data_style").val()){if("Please select"===$("#panel-bar__bar_column").val())return[{errorType:MISSING_FIELD_ERROR,field:"panel-bar__bar_column"}]}else if("Please select"===$("#panel-bar__panel_column").val())return[{errorType:MISSING_FIELD_ERROR,field:"panel-bar__panel_column"}];break;case"panel_line_chart":if("Please select"===$("#panel-line__x-axis_column").val())return[{errorType:MISSING_FIELD_ERROR,field:"panel-line__x-axis_column"}];break;default:return[{errorType:MISSING_FIELD_ERROR,field:"chart_type_selector"}]}return[]}function getEthnicityColumnHeader(){for(var e in chart_data[0]){if(0<=chart_data[0][e].toLowerCase().search("ethnic"))return chart_data[0][e]}return null}function getSecondaryColumnHeader(){switch($("#chart_type_selector").val()){case"bar_chart":return null;case"line_graph":return $("#line__x-axis_column").val();case"grouped_bar_chart":return"ethnicity_as_group"===$("#grouped-bar__data_style").val()?$("#grouped-bar__bar_column").val():$("#grouped-bar__groups_column").val();case"component_chart":return"ethnicity_as_sections"===$("#component__data_style").val()?$("#component__bar_column").val():$("#component__section_column").val();case"panel_bar_chart":return"ethnicity_as_panels"===$("#panel-bar__data_style").val()?$("#panel-bar__bar_column").val():$("#panel-bar__panel_column").val();case"panel_line_chart":return $("#panel-line__x-axis_column").val();default:return null}}function pasteJson(e){var t=document.getElementById("data_text_area");t.value=_.map(e,function(e){return e.join("\t")}).join("\n"),t.dispatchEvent(new Event("keyup"))}function hideErrors(){document.getElementById("errors_container").classList.add("hidden"),$(".govuk-error-message").addClass("hidden"),$(".govuk-form-group--error").removeClass("govuk-form-group--error")}
//# sourceMappingURL=chartbuilder.js.map
