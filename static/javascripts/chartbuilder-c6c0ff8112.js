var presets=[],chart_data=null,current_data="",current_settings=null;function getNumberFormat(){var e=$("#number_format").val();return"none"===e?{multiplier:1,prefix:"",suffix:"",min:"",max:""}:"percent"===e?{multiplier:1,prefix:"",suffix:"%",min:0,max:100}:"other"===e?{multiplier:1,prefix:$("#number_format_prefix").val(),suffix:$("#number_format_suffix").val(),min:$("#number_format_min").val(),max:$("#number_format_max").val()}:void 0}function getTips(){var e=validateChart(chart_data);if(0!==e.length)return e;var t=checkRequiredFields();if(0!==t.length)return t;var a=getEthnicityColumnHeader(),n=getSecondaryColumnHeader();return validateData(chart_data,a,n)}$(document).ready(function(){function t(t){var e=$("#data_text_area").val();0<(chart_data=textToData(e)).length&&(message=chart_data.length-1+" rows by "+chart_data[0].length+" columns"),document.getElementById("data-description").innerHTML=message;var a,n,r,_=chart_data[0];n=o(a=_,"[None]"),r=o(a,"Please select"),document.getElementById("line__x-axis_column").innerHTML=r,document.getElementById("grouped-bar__bar_column").innerHTML=r,document.getElementById("grouped-bar__groups_column").innerHTML=r,document.getElementById("component__bar_column").innerHTML=r,document.getElementById("component__bar_order").innerHTML=n,document.getElementById("component__section_column").innerHTML=r,document.getElementById("component__section_order").innerHTML=n,document.getElementById("panel-bar__panel_column").innerHTML=r,document.getElementById("panel-bar__panel_order").innerHTML=n,document.getElementById("panel-bar__bar_column").innerHTML=r,document.getElementById("panel-bar__bar_order").innerHTML=n,document.getElementById("panel-line__x-axis_column").innerHTML=r;var c=i(chart_data);$.ajax({type:"post",url:url_get_classifications,dataType:"json",data:JSON.stringify({data:c}),contentType:"application/json; charset=utf-8",success:function(e){(function(e){var t="";for(var a in e){var n=e[a].preset.name,r=e[a].preset.id;t=0===a?t+'<option value="'+r+'" selected>'+n+"</option>":t+'<option value="'+r+'" >'+n+"</option>"}document.getElementById("ethnicity_settings").innerHTML=t})(presets=e.presets),l(),document.getElementById("ethnicity_settings_section").classList.remove("hidden"),document.getElementById("select_chart_type").classList.remove("hidden"),t&&t()},failure:function(){console.log("failed to get ethnicity classifcations")},error:function(e){console.log(e)}})}function i(e){var t=_.clone(e),a=function(e){for(var t=0;t<e.length;t++){var a=e[t].toLowerCase().trim();if(0<=a.indexOf("ethnic"))return t}return-1}(t.shift());return 0<=a?_.pluck(t,a):[]}function l(){"custom"===$("#ethnicity_settings").val()?document.getElementById("custom_classification__panel").classList.remove("hidden"):document.getElementById("custom_classification__panel").classList.add("hidden")}function o(e,t){var a='<option value="'+t+'" selected>'+t+"</option>",n=function(e){var t=["Measure","Ethnicity","Ethnic group","Value","Values"],a=[];for(h in e){var n=e[h];t.indexOf(n)<0&&a.push(n)}return a}(e);for(var r in n){var _=n[r];a=a+'<option value="'+_+'">'+_+"</option>"}return a}function a(e){var t=getTips();0<t.length?function(e){document.getElementById("tips_container").classList.remove("hidden"),document.getElementById("preview_container").classList.add("hidden"),document.getElementById("notes_container").classList.add("hidden"),document.getElementById("errors_container").classList.add("hidden");for(var t=document.getElementById("tip-list"),a=0;a<t.children.length;a++)t.children[a].classList.add("hidden");0<n(e,MISSING_FIELD_ERROR).length&&document.getElementById("notes_container").classList.remove("hidden");0<n(e,ETHNICITY_ERROR).length&&(document.getElementById("errors_container").classList.remove("hidden"),document.getElementById("tip__ethnicity-column").classList.remove("hidden"));0<n(e,VALUE_ERROR).length&&(document.getElementById("errors_container").classList.remove("hidden"),document.getElementById("tip__value-column").classList.remove("hidden"));0<n(e,RECTANGLE_ERROR).length&&(document.getElementById("errors_container").classList.remove("hidden"),document.getElementById("tip__rectangular-data").classList.remove("hidden"));0<n(e,DATA_ERROR_COMPLEX_DATA).length&&(document.getElementById("errors_container").classList.remove("hidden"),document.getElementById("tip__complex-data").classList.remove("hidden"));0<n(e,DATA_ERROR_DUPLICATION).length&&(document.getElementById("errors_container").classList.remove("hidden"),document.getElementById("tip__duplicate-data").classList.remove("hidden"));0<n(e,DATA_ERROR_MISSING_DATA).length&&(document.getElementById("errors_container").classList.remove("hidden"),document.getElementById("tip__missing-data").classList.remove("hidden"))}(t):function(){document.getElementById("tips_container").classList.add("hidden"),document.getElementById("preview_container").classList.remove("hidden");var e=u();e&&(e.title="",drawChart("container",e),document.getElementById("save_section").classList.remove("hidden"));document.getElementById("chart_title").dispatchEvent(new Event("input"))}()}function n(e,t){return _.filter(e,function(e){return e.errorType===t})}function c(){var e=$("#data_text_area").val(),t=$("#chart_type_selector").val();return{data:textToData(e),type:t,preset:s(),custom:m(),chartOptions:function(e){switch(e){case"bar_chart":return{};case"line_graph":return{x_axis_column:$("#line__x-axis_column").val()};case"grouped_bar_chart":var t=$("#grouped-bar__data_style").val();return"ethnicity_as_group"===t?{data_style:t,bar_column:$("#grouped-bar__bar_column").val()}:{data_style:t,group_column:$("#grouped-bar__groups_column").val()};case"component_chart":var t=$("#component__data_style").val();return"ethnicity_as_sections"===t?{data_style:t,bar_column:$("#component__bar_column").val(),bar_order:$("#component__bar_order").val()}:{data_style:t,section_column:$("#component__section_column").val(),section_order:$("#component__section_order").val()};case"panel_bar_chart":var t=$("#panel-bar__data_style").val();return"ethnicity_as_panels"===t?{data_style:t,bar_column:$("#panel-bar__bar_column").val(),bar_order:$("#panel-bar__bar_order").val()}:{data_style:t,panel_column:$("#panel-bar__panel_column").val(),panel_order:$("#panel-bar__panel_order").val()};case"panel_line_chart":return{x_axis_column:$("#panel-line__x-axis_column").val()};default:return{}}}(t),chartFormat:{chart_title:$("#chart_title").val(),x_axis_label:$("#x_axis_label").val(),y_axis_label:$("#y_axis_label").val(),number_format:$("#number_format").val(),number_format_prefix:$("#number_format_prefix").val(),number_format_suffix:$("#number_format_suffix").val(),number_format_min:$("#number_format_min").val(),number_format_max:$("#number_format_max").val()}}}function s(){return $("#ethnicity_settings").val()}function d(){return $("#custom_classification__selector").val()}function m(){return{code:d(),hasParents:$("#custom_classification__has_parents").prop("checked"),hasAll:$("#custom_classification__has_all").prop("checked"),hasUnknown:$("#custom_classification__has_unknown").prop("checked")}}function u(){var e=$("#chart_type_selector").val(),t=null,a=function(e){for(p in presets)if(presets[p].preset.id===e)return presets[p];return null}($("#ethnicity_settings").val());if("bar_chart"===e)t=barchartObject(v(a,chart_data,["value"]),"Ethnicity","[None]","Ethnicity-parent","Ethnicity-order",$("#chart_title").val(),$("#x_axis_label").val(),$("#y_axis_label").val(),getNumberFormat());else if("line_graph"===e){var n=$("#line__x-axis_column").val();t=linechartObject(v(a,chart_data,["value",n]),n,"Ethnicity",$("#chart_title").val(),$("#x_axis_label").val(),$("#y_axis_label").val(),getNumberFormat(),"Ethnicity-order")}else if("grouped_bar_chart"===e)if("ethnicity_as_group"===$("#grouped-bar__data_style").val()){var r=$("#grouped-bar__bar_column").val();t=barchartObject(v(a,chart_data,["value",r]),"Ethnicity",r,"[None]","Ethnicity-order",$("#chart_title").val(),$("#x_axis_label").val(),$("#y_axis_label").val(),getNumberFormat())}else{var _=$("#grouped-bar__groups_column").val();t=barchartObject(v(a,chart_data,["value",_]),_,"Ethnicity","[None]","Ethnicity-order",$("#chart_title").val(),$("#x_axis_label").val(),$("#y_axis_label").val(),getNumberFormat())}else if("component_chart"===e)if("ethnicity_as_bar"===$("#component__data_style").val()){var c=$("#component__section_column").val(),i=$("#component__section_order").val(),l=[];l=v(a,chart_data,i&&"[None]"!==i?["value",c,i]:["value",c]),t=componentChartObject(l,"Ethnicity",c,$("#chart_title").val(),$("#x_axis_label").val(),$("#y_axis_label").val(),getNumberFormat(),"Ethnicity-order",i)}else{_=$("#component__bar_column").val();var o=$("#component__bar_order").val();l=[];l=v(a,chart_data,o&&"[None]"!==o?["value",_,o]:["value",_]),t=componentChartObject(v(a,chart_data,["value",_]),_,"Ethnicity",$("#chart_title").val(),$("#x_axis_label").val(),$("#y_axis_label").val(),getNumberFormat(),o,"Ethnicity-order")}else if("panel_bar_chart"===e)if("ethnicity_as_panel_bars"===$("#panel-bar__data_style").val()){var s=$("#panel-bar__panel_column").val(),d=$("#panel-bar__panel_order").val();l=[];l=v(a,chart_data,d&&"[None]"!==d?["value",s,d]:["value",s]),t=panelBarchartObject(l,"Ethnicity",s,$("#chart_title").val(),"","",getNumberFormat(),"Ethnicity-order",d)}else{var m=$("#panel-bar__bar_column").val(),u=$("#panel-bar__bar_order").val();l=[];l=v(a,chart_data,m&&"[None]"!==u?["value",m,u]:["value",m]),t=panelBarchartObject(l,m,"Ethnicity",$("#chart_title").val(),"","",getNumberFormat(),u,"Ethnicity-order")}else if("panel_line_chart"===e){var h=$("#panel-line__x-axis_column").val();l=v(a,chart_data,["value",h]);t=panelLinechartObject(l,h,"Ethnicity",$("#chart_title").val(),"","",getNumberFormat(),"Ethnicity-order")}return t}function v(e,t,a){var n=[["Ethnicity","Ethnicity-parent","Ethnicity-order"].concat(a)],r=_.clone(t),c=r.shift(),i=_.map(c,function(e){return e.toLowerCase().trim()}),l=_.map(a,function(e){var t=e.toLowerCase().trim();return i.indexOf(t)});for(var o in e.data){var s=e.data[o],d=[s.preset,s.parent,s.order];d=d.concat(_.map(l,function(e){return-1===e?"":r[o][e]})),n=n.concat([d])}return n}function r(e){$("#chart_type_selector").val(e);for(var t=document.getElementsByClassName("chart-option-group"),a=0;a<t.length;a++)t[a].classList.add("hidden");"none"!==e&&(document.getElementById(e+"_options").classList.remove("hidden"),document.getElementById("chart_format_options").classList.remove("hidden"))}function y(e){var t,a,n,r;t=e.code,$("#custom_classification__selector").val(t),a=e.hasParents,$("#custom_classification__has_parents").prop("checked",a),n=e.hasAll,$("#custom_classification__has_all").prop("checked",n),r=e.hasUnknown,$("#custom_classification__has_unknown").prop("checked",r)}function g(e){var t;switch($("#chart_type_selector").val(e.type),r(e.type),e.preset&&(t=e.preset,$("#ethnicity_settings").val(t)),e.custom&&y(e.custom),l(),$("#chart_title").val(e.chartFormat.chart_title),e.type){case"line_graph":var a=e.chartOptions.x_axis_column;$("#line__x-axis_column").val(a);break;case"grouped_bar_chart":var n=e.chartOptions.data_style;$("#grouped-bar__data_style").val(n),"ethnicity_as_group"===n?($("#grouped-bar__bar_column").val(e.chartOptions.bar_column),document.getElementById("grouped-bar__ethnicity_is_group").classList.remove("hidden"),document.getElementById("grouped-bar__ethnicity_is_bar").classList.add("hidden")):($("#grouped-bar__groups_column").val(e.chartOptions.group_column),document.getElementById("grouped-bar__ethnicity_is_group").classList.add("hidden"),document.getElementById("grouped-bar__ethnicity_is_bar").classList.remove("hidden"));break;case"component_chart":n=e.chartOptions.data_style;$("#component__data_style").val(n),"ethnicity_as_sections"===n?($("#component__bar_column").val(e.chartOptions.bar_column),$("#component__bar_order").val(e.chartOptions.bar_order),document.getElementById("component__ethnicity_is_sections").classList.remove("hidden"),document.getElementById("component__ethnicity_is_bar").classList.add("hidden")):($("#component__section_column").val(e.chartOptions.section_column),$("#component__section_order").val(e.chartOptions.section_order),document.getElementById("component__ethnicity_is_sections").classList.add("hidden"),document.getElementById("component__ethnicity_is_bar").classList.remove("hidden"));break;case"panel_bar_chart":n=e.chartOptions.data_style;$("#panel-bar__data_style").val(n),"ethnicity_as_panels"===n?($("#panel-bar__bar_column").val(e.chartOptions.bar_column),$("#panel-bar__bar_order").val(e.chartOptions.bar_order),document.getElementById("panel-bar__ethnicity_as_bar").classList.add("hidden"),document.getElementById("panel-bar__ethnicity_as_panels").classList.remove("hidden")):($("#panel-bar__panel_column").val(e.chartOptions.panel_column),$("#panel-bar__panel_order").val(e.chartOptions.panel_order),document.getElementById("panel-bar__ethnicity_as_bar").classList.remove("hidden"),document.getElementById("panel-bar__ethnicity_as_panels").classList.add("hidden"));break;case"panel_line_chart":a=e.chartOptions.x_axis_column;$("#panel-line__x-axis_column").val(a)}$("#number_format").val(e.chartFormat.number_format),$("#number_format_prefix").val(e.chartFormat.number_format_prefix),$("#number_format_suffix").val(e.chartFormat.number_format_suffix),$("#number_format_min").val(e.chartFormat.number_format_min),$("#number_format_max").val(e.chartFormat.number_format_max),"other"===e.chartFormat.number_format&&document.getElementById("other_number_format").classList.remove("hidden")}document.getElementById("confirm-data").addEventListener("click",function(e){t(function(){current_settings&&g(current_settings),a()}),document.getElementById("data-panel").classList.add("hidden"),document.getElementById("edit-panel").classList.remove("hidden"),document.getElementById("builder-title").textContent="Format and view chart"}),document.getElementById("edit-data").addEventListener("click",function(e){current_data=$("#data_text_area").val(),current_settings=c(),document.getElementById("data-panel").classList.remove("hidden"),document.getElementById("edit-panel").classList.add("hidden"),document.getElementById("builder-title").textContent="Create a chart"}),document.getElementById("cancel-edit-data").addEventListener("click",function(e){$("#data_text_area").val(current_data),document.getElementById("data-panel").classList.add("hidden"),document.getElementById("edit-panel").classList.remove("hidden"),document.getElementById("builder-title").textContent="Format and view chart"}),document.getElementById("save").addEventListener("click",function(e){$("#save").attr("disabled","disabled");var t=u(),a=c();t&&(r=a,(n=t)&&($.each(n.series,function(){for(var e=0;e<this.data.length;e++)isNaN(this.data[e].y)&&(this.data[e].y=0)}),$.ajax({type:"POST",url:url_save_chart_to_page,dataType:"json",data:JSON.stringify({chartObject:n,source:r,classificationCode:s(),customClassificationCode:d(),customClassification:m(),ethnicityValues:i(chart_data)}),contentType:"application/json",success:function(){location.reload()}})));var n,r}),$("#ethnicity_settings").change(function(){l(),a()}),$("#custom_classification__selector").change(a),$("#chart_type_selector").change(function(){r($(this).val()),a()}),$("#line__x-axis_column").change(a),$("#grouped-bar__data_style").change(function(){"ethnicity_as_group"===$(this).val()?(document.getElementById("grouped-bar__ethnicity_is_group").classList.remove("hidden"),document.getElementById("grouped-bar__ethnicity_is_bar").classList.add("hidden")):(document.getElementById("grouped-bar__ethnicity_is_group").classList.add("hidden"),document.getElementById("grouped-bar__ethnicity_is_bar").classList.remove("hidden")),a()}),$("#grouped-bar__bar_column").change(a),$("#grouped-bar__bar_order").change(a),$("#grouped-bar__groups_column").change(a),$("#grouped-bar__groups_order").change(a),$("#component__data_style").change(function(){"ethnicity_as_bar"===$(this).val()?(document.getElementById("component__ethnicity_is_bar").classList.remove("hidden"),document.getElementById("component__ethnicity_is_sections").classList.add("hidden")):(document.getElementById("component__ethnicity_is_bar").classList.add("hidden"),document.getElementById("component__ethnicity_is_sections").classList.remove("hidden")),a()}),$("#component__section_column").change(a),$("#component__section_order").change(a),$("#component__bar_column").change(a),$("#component__bar_order").change(a),$("#panel-bar__data_style").change(function(){"ethnicity_as_panel_bars"===$(this).val()?(document.getElementById("panel-bar__ethnicity_as_bar").classList.remove("hidden"),document.getElementById("panel-bar__ethnicity_as_panels").classList.add("hidden")):(document.getElementById("panel-bar__ethnicity_as_bar").classList.add("hidden"),document.getElementById("panel-bar__ethnicity_as_panels").classList.remove("hidden")),a()}),$("#panel-bar__bar_column").change(a),$("#panel-bar__bar_order").change(a),$("#panel-bar__panel_column").change(a),$("#panel-bar__panel_order").change(a),$("#panel-line__x-axis_column").change(a),$("#number_format").change(function(){"other"===$(this).val()?document.getElementById("other_number_format").classList.remove("hidden"):document.getElementById("other_number_format").classList.add("hidden"),a()}),function(){if(settings.data){var e=_.map(settings.data,function(e){return e.join("\t")}).join("\n");$("#data_text_area").val(e),t(function(){document.getElementById("data-panel").classList.add("hidden"),document.getElementById("edit-panel").classList.remove("hidden"),g(settings),a()})}}()});var MISSING_FIELD_ERROR="Missing field error";function checkRequiredFields(){if("custom"===$("#ethnicity_settings").val()&&"Please select"===$("#custom_classification__selector").val())return[{errorType:MISSING_FIELD_ERROR,field:"custom_classification__selector"}];switch($("#chart_type_selector").val()){case"bar_chart":return[];case"line_graph":if("Please select"===$("#line__x-axis_column").val())return[{errorType:MISSING_FIELD_ERROR,field:"line__x-axis_column"}];break;case"grouped_bar_chart":if("ethnicity_as_group"===$("#grouped-bar__data_style").val()){if("Please select"===$("#grouped-bar__bar_column").val())return[{errorType:MISSING_FIELD_ERROR,field:"grouped-bar__bar_column"}]}else if("Please select"===$("#grouped-bar__groups_column").val())return[{errorType:MISSING_FIELD_ERROR,field:"grouped-bar__groups_column"}];break;case"component_chart":if("ethnicity_as_sections"===$("#component__data_style").val()){if("Please select"===$("#component__bar_column").val())return[{errorType:MISSING_FIELD_ERROR,field:"component__bar_column"}]}else if("Please select"===$("#component__section_column").val())return[{errorType:MISSING_FIELD_ERROR,field:"component__section_column"}];break;case"panel_bar_chart":if("ethnicity_as_panels"===$("#panel-bar__data_style").val()){if("Please select"===$("#panel-bar__bar_column").val())return[{errorType:MISSING_FIELD_ERROR,field:"panel-bar__bar_column"}]}else if("Please select"===$("#panel-bar__panel_column").val())return[{errorType:MISSING_FIELD_ERROR,field:"panel-bar__panel_column"}];break;case"panel_line_chart":if("Please select"===$("#panel-line__x-axis_column").val())return[{errorType:MISSING_FIELD_ERROR,field:"panel-line__x-axis_column"}];break;default:return[{errorType:MISSING_FIELD_ERROR,field:"chart_type_selector"}]}return[]}function getEthnicityColumnHeader(){for(var e in chart_data[0]){if(0<=chart_data[0][e].toLowerCase().search("ethnic"))return chart_data[0][e]}return null}function getSecondaryColumnHeader(){switch($("#chart_type_selector").val()){case"bar_chart":return null;case"line_graph":return $("#line__x-axis_column").val();case"grouped_bar_chart":return"ethnicity_as_group"===$("#grouped-bar__data_style").val()?$("#grouped-bar__bar_column").val():$("#grouped-bar__groups_column").val();case"component_chart":return"ethnicity_as_sections"===$("#component__data_style").val()?$("#component__bar_column").val():$("#component__section_column").val();case"panel_bar_chart":return"ethnicity_as_panels"===$("#panel-bar__data_style").val()?$("#panel-bar__bar_column").val():$("#panel-bar__panel_column").val();case"panel_line_chart":return $("#panel-line__x-axis_column").val();default:return null}}function pasteJson(e){var t=document.getElementById("data_text_area");t.value=_.map(e,function(e){return e.join("\t")}).join("\n"),t.dispatchEvent(new Event("keyup"))}
//# sourceMappingURL=chartbuilder.js.map
