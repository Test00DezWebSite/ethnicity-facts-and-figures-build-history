{"version":3,"sources":["tablebuilder.js","rd-builder.js","rd-data-tools.js"],"names":["classifications","table_data","current_data","current_settings","unselectedOptionString","getEthnicityColumn","headers","index","length","toLowerCase","trim","indexOf","getEthnicityValues","data","all_data","_","clone","column","shift","pluck","getIsSimpleData","values","uniq","getNumberFormat","format","$","val","multiplier","prefix","suffix","min","max","getTips","basicErrors","validateTable","missingFields","checkRequiredFields","ethnicityColumn","getEthnicityColumnHeader","secondaryColumn","getSecondaryColumnHeader","validateData","document","addEventListener","handleNewData","on_success","tabbedData","getElementById","value","textToData","message","innerHTML","listWithNone","listWithRequired","dropdownHtmlWithDefault","html","ethnicity_data","ajax","type","url","url_get_classifications","dataType","JSON","stringify","contentType","success","response","c","classification_name","classification_id","populateEthnicityClassifications","showHideCustomEthnicityPanel","classList","remove","add","failure","console","log","error","err","defaultValue","defaultLabel","stripped","exclude","h","header","push","strippedHeaders","dataColumnChange","evt","selected_column_name","this","id","new_column_name","preview","tips","tip_list","i","children","tipsOfType","MISSING_FIELD_ERROR","ETHNICITY_ERROR","RECTANGLE_ERROR","DATA_ERROR_DUPLICATION","DATA_ERROR_MISSING_DATA","displayTips","tableObject","innerBuildTableObject","title","text","drawTable","dispatchEvent","Event","displayTable","errorType","filter","tip","getTablePageSettings","preset","getClassificationCode","custom","getCustomObject","tableOptions","dataStyle","selection","order","data_style","getTableTypeOptions","tableValues","table_title","table_column_1","table_column_1_name","table_column_2","table_column_2_name","table_column_3","table_column_3_name","table_column_4","table_column_4_name","table_column_5","table_column_5_name","table_index_column_name","getCustomClassificationCode","code","hasParents","prop","hasAll","hasUnknown","notNullOrNone","buildTableColumns","columns","each","idx","buildTableColumnNames","classification","getClassificationById","buildTableObject","buildDataWithClassifications","all_table_columns","concat","rows","body","lowHeaders","map","indices","col","lowCol","r","item","row","selectCustomValues","customObject","customClassification","customValue","selectDataStyle","modifyIndexColumnNameAndPreview","indexColumnName","setupTablebuilderWithSettings","settings","NONE_VALUE","focus","attr","tableBuilderSettings","src","series","isNaN","y","url_save_table_to_page","source","classificationCode","customClassificationCode","ethnicityValues","location","reload","change","data_text","d","join","initialiseForm","field","search","pasteJson","json","data_text_area","DATA_ERROR_SETTINGS_ERROR","DATA_ERROR_COMPLEX_DATA","categoryColumn","groupColumn","dataRows","headerRow","lowerHeaderRow","m","categoryIndex","index_of_column_named","groupIndex","validateGroupedData","validateSimpleData","validateDataDuplicatesOnly","validateGroupedDataDuplicates","duplicateErrors","uniqueCategories","dict","forEach","category","completeErrors","validateGroupedDataCompleteness","rowItems","columnItems","errors","mapOfPairs","object","contains","group","groupValuesUsedByCategory","categoryValue","groupValue","errorDescription","errorResolutionHint","exports","require","dataTools","filterData","applyFilter","textFilterToIndexFilter","numerateColumns","numerateColumn","toFloat","textFilter","indexFilter","key","data2","filteredRows","datum","itemPassesFilter","unshift","formatNumber","numStr","number","replaceAll","formatted","toLocaleString","formatNumberWithDecimalPlaces","dp","match","replace","minimumFractionDigits","maximumFractionDigits","seriesDecimalPlaces","maxDp","s","decimalPlaces","seriesCouldBeYear","valueStr","decimalFigureMatch","String","uniqueDataInColumn","slice","start","sort","uniqueDataInColumnOrdered","order_column","sorted","sortBy","uniqueDataInColumnMaintainOrder","used","textData","delimiter","splitLineAndTrimEachItem","line","split","lines","VALUE_ERROR","validateChart","hasHeader","isRectangular","found","str","size","nonNumericData","nonNumeric"],"mappings":"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","file":"tablebuilder.js","sourcesContent":["/*\n    Functionality of tablebuilder including the main methods that run each stage\n\n\n    On open **initialiseForm()**\n    - grab current_settings from dimension.table_settings_and_source_data if such a thing exists\n    - if current_settings doesn't exist open with the data area open.\n    - otherwise set the current_settings from file, paste data into the data panel and run the On new data routine below\n\n    On new data (changing data in the data panel area and clicking OK) **handleNewData()**\n    - use an AJAX call to the /get-valid-classifications-for-data endpoint to add extra values **buildDataWithClassifications()**\n    - populate the table builder dropdowns with correct values **populateTableOptions(), populateEthnicityClassifications()**\n    - if any settings currently exist apply as many as are still relevant **setupTablebuilderWithSettings()**\n\n    On settings changes\n    - validate they will make a viable table **getTips()**\n    - if so use the rd table object factory and renderer to display a preview **preview()**\n    - otherwise display an error and tip to fix it **displayTips()**\n\n    On save\n    - build a table object with the rd-table-object factory **buildTableObject()**\n    - create a table_settings lump of json **getTablePageSettings()**\n    - post both to <dimension>/create-table endpoint **postTableObject()**\n\n */\n\n// The main working data variables\nvar classifications = [];\nvar table_data = null;\n\n// Variables that needs to be maintained when the user makes changes to the text data\nvar current_data = \"\";\nvar current_settings = null;\n\nvar unselectedOptionString = \"Please select\";\n\nfunction getEthnicityColumn(headers) {\n    for (var index = 0; index < headers.length; index++) {\n        var cleanHeader = headers[index].toLowerCase().trim();\n        if (cleanHeader.indexOf('ethnic') >= 0) {\n            return index\n        }\n    }\n    return -1;\n}\n\nfunction getEthnicityValues(data) {\n    var all_data = _.clone(data);\n    var headers = all_data.shift();\n\n    var column = getEthnicityColumn(headers);\n    if (column >= 0) {\n        return _.pluck(all_data, column);\n    }\n    return [];\n}\n\nfunction getIsSimpleData(data) {\n    var values = getEthnicityValues(data);\n    values = _.uniq(values);\n    return values.length === data.length - 1\n}\n\ndocument.addEventListener('DOMContentLoaded', function() {\n\n    // add events to buttons\n    document.getElementById('confirm-data').addEventListener('click', setTableData)\n    document.getElementById('edit-data').addEventListener('click', editTableData)\n    document.getElementById('cancel-edit-data').addEventListener('click', cancelEditData)\n    document.getElementById('save').addEventListener('click', saveTable)\n\n    /*\n        Events from the DATA ENTRY PANEL\n     */\n\n    function setTableData(evt) {\n        handleNewData(function () {\n            if (current_settings) {\n                setupTablebuilderWithSettings(current_settings)\n            }\n            preview()\n        });\n\n        document.getElementById('data-panel').classList.add('hidden')\n        document.getElementById('edit-panel').classList.remove('hidden')\n        document.getElementById('builder-title').innerHTML = 'Format and view table';\n    }\n\n    function editTableData(evt) {\n        current_data = document.getElementById('data_text_area').value\n        current_settings = getTablePageSettings();\n\n        document.getElementById('data-panel').classList.remove('hidden')\n        document.getElementById('data_text_area').focus()\n        document.getElementById('edit-panel').classList.add('hidden')\n        document.getElementById('builder-title').innerHTML = 'Create a table';\n    }\n\n    function cancelEditData(evt) {\n        document.getElementById('data_text_area').value = current_data;\n        document.getElementById('data-panel').classList.add('hidden')\n        document.getElementById('edit-panel').classList.remove('hidden')\n        document.getElementById('builder-title').innerHTML = 'Format and view table';\n    }\n\n\n    /*\n        Initialise the main editor after DATA ENTRY PANEL change\n    */\n\n    function handleNewData(on_success) {\n\n        // get the data\n        var tabbedData = document.getElementById('data_text_area').value\n\n        // set the DATA DISPLAY content\n        table_data = textToData(tabbedData);\n        if (table_data.length > 0) {\n            message = table_data.length - 1 + ' rows by ' + table_data[0].length + ' columns'\n        }\n        document.getElementById('data-description').innerHTML = message;\n\n        // update options in drop-downs\n        var headers = table_data[0];\n        populateTableOptions(headers);\n\n        // call the backend to do the classifications heavy lifting\n        var ethnicity_data = getEthnicityValues(table_data);\n        $.ajax({\n            type: \"post\",\n            url: url_get_classifications,\n            dataType: 'json',\n            data: JSON.stringify({'data': ethnicity_data}),\n            contentType: 'application/json; charset=utf-8',\n            success: function (response) {\n                // upon heavy lifting complete\n\n                // populate the ethnicity classifications from the response\n                classifications = response['classifications'];\n                populateEthnicityClassifications(classifications);\n                showHideCustomEthnicityPanel()\n\n                // show the classifications (step 2) and table type (step 3) section\n                document.getElementById('ethnicity_settings_section').classList.remove('hidden')\n\n                if (getIsSimpleData(table_data)) {\n                    document.getElementById('complex_table_options').classList.add('hidden')\n                } else {\n                    document.getElementById('complex_table_options').classList.remove('hidden')\n                }\n\n                // any further processing\n                if (on_success) {\n                    on_success();\n                }\n            },\n            failure: function () {\n                console.log('failed to get ethnicity classifications');\n            },\n            error: function (err) {\n                console.log(err);\n            }\n        });\n    }\n\n\n    /*\n        SETUP\n    */\n\n    function populateTableOptions(headers) {\n        var listWithNone = dropdownHtmlWithDefault(headers, 'none', '[None]');\n        var listWithSquareNone = dropdownHtmlWithDefault(headers, '[None]', '[None]');\n        var listWithRequired = dropdownHtmlWithDefault(headers, unselectedOptionString, unselectedOptionString);\n\n        $('#ethnicity-as-row__columns').html(listWithRequired);\n        $('#ethnicity-as-row__column-order').html(listWithRequired);\n        $('#ethnicity-as-column__rows').html(listWithRequired);\n        $('#ethnicity-as-column__row-order').html(listWithRequired);\n\n        $('#table_column_1').html(listWithRequired);\n        $('#table_column_2').html(listWithNone);\n        $('#table_column_3').html(listWithNone);\n        $('#table_column_4').html(listWithNone);\n        $('#table_column_5').html(listWithNone);\n\n        $('#index_column_name').val('Ethnicity')\n    }\n\n    function selectDropdown(dropdown_id, value) {\n        var dropdown = document.getElementById(dropdown_id);\n        for (var i = 0; i < dropdown.length; i++) {\n            dropdown[i].selected = (dropdown[i].value === value)\n        }\n    }\n\n    function showHideCustomEthnicityPanel() {\n        if ($('#ethnicity_settings').val() === 'custom') {\n            document.getElementById('custom_classification__panel').classList.remove('hidden')\n        } else {\n            document.getElementById('custom_classification__panel').classList.add('hidden')\n        }\n    }\n\n    function populateEthnicityClassifications(classifications) {\n        var html = '';\n        for (var c in classifications) {\n            var classification_name = classifications[c]['classification']['name'];\n            var classification_id = classifications[c]['classification']['id'];\n            if (c === 0) {\n                html = html + '<option value=\"' + classification_id + '\" selected>' + classification_name + '</option>';\n            } else {\n                html = html + '<option value=\"' + classification_id + '\" >' + classification_name + '</option>';\n            }\n        }\n        document.getElementById('ethnicity_settings').innerHTML = html\n    }\n\n    function strippedHeaders(headers) {\n        var exclude = [];\n        var stripped = [];\n        for (h in headers) {\n            var header = headers[h];\n            if (exclude.indexOf(header) < 0) {\n                stripped.push(header);\n            }\n        }\n        return stripped;\n    }\n\n    function dropdownHtmlWithDefault(headers, defaultValue, defaultLabel) {\n        var html = '<option value=\"' + defaultValue + '\" selected>' + defaultLabel + '</option>';\n        var stripped = strippedHeaders(headers);\n        for (var h in stripped) {\n            var header = stripped[h];\n            html = html + '<option value=\"' + header + '\">' + header + '</option>';\n        }\n        return html;\n    }\n\n    /*\n        PREVIEW\n        Render the table as a preview using drawTable() from rd-graph.js\n        (this the exact same method that is used front-end)\n    */\n\n    function dataColumnChange(evt) {\n        var selected_column_name = $('#' + this.id + ' option:selected').val();\n\n        var new_column_name = (selected_column_name === unselectedOptionString) ? \"\" : selected_column_name;\n\n        $('#' + this.id + '_name').val(new_column_name);\n\n        preview(evt);\n    }\n\n    function preview(evt) {\n        var tips = getTips();\n        if (tips.length > 0) {\n            displayTips(tips);\n        } else {\n            displayTable();\n        }\n    }\n\n    function displayTips(tips) {\n        document.getElementById('tips_container').classList.remove('hidden')\n        document.getElementById('preview_container').classList.add('hidden')\n\n        document.getElementById('notes_container').classList.add('hidden')\n        document.getElementById('errors_container').classList.add('hidden')\n\n        var tip_list = document.getElementById('tip-list')\n        for (var i = 0; i < tip_list.children.length; i++) {\n            tip_list.children[i].classList.add('hidden')\n        }\n\n        if (tipsOfType(tips, MISSING_FIELD_ERROR).length > 0) {\n            document.getElementById('notes_container').classList.remove('hidden')\n        }\n        if (tipsOfType(tips, ETHNICITY_ERROR).length > 0) {\n            document.getElementById('errors_container').classList.remove('hidden')\n            document.getElementById('tip__ethnicity-column').classList.remove('hidden')\n        }\n        if (tipsOfType(tips, RECTANGLE_ERROR).length > 0) {\n            document.getElementById('errors_container').classList.remove('hidden')\n            document.getElementById('tip__rectangular-data').classList.remove('hidden')\n        }\n        if (tipsOfType(tips, DATA_ERROR_DUPLICATION).length > 0) {\n            document.getElementById('errors_container').classList.remove('hidden')\n            document.getElementById('tip__duplicate-data').classList.remove('hidden')\n        }\n        if (tipsOfType(tips, DATA_ERROR_MISSING_DATA).length > 0) {\n            document.getElementById('errors_container').classList.remove('hidden')\n            document.getElementById('tip__missing-data').classList.remove('hidden')\n        }\n\n    }\n\n    function tipsOfType(tips, errorType) {\n        return _.filter(tips, function (tip) {\n            return tip.errorType === errorType;\n        })\n    }\n\n    function displayTable() {\n        document.getElementById('tips_container').classList.add('hidden')\n        document.getElementById('preview_container').classList.remove('hidden')\n\n        var tableObject = innerBuildTableObject();\n        if (tableObject) {\n            if (tableObject.title && tableObject.title.text) {\n                $('#title-container').html('<h3 class=\"heading-small\">' + tableObject.title.text + '</h3>');\n            }\n            tableObject.title = '';\n            drawTable('container', tableObject);\n\n            document.getElementById('save_section').classList.remove('hidden')\n        }\n        document.getElementById('table_title').dispatchEvent(new Event(\"input\"));\n    }\n\n    /*\n        SAVE\n        Save the table by building a tableObject and bundling up all the setting then sending it to the backend\n    */\n\n    function saveTable(evt) {\n\n        $('#save').attr('disabled', 'disabled');\n\n        var tableObject = innerBuildTableObject();\n        var tableBuilderSettings = getTablePageSettings();\n        if (tableObject) {\n            postTableObject(tableObject, tableBuilderSettings);\n        }\n    }\n\n    function postTableObject(tableObject, src) {\n        if (tableObject) {\n            // adjust for null data\n            $.each(tableObject.series, function () {\n                for (var i = 0; i < this.data.length; i++) {\n                    if (isNaN(this.data[i].y)) {\n                        this.data[i].y = 0;\n                    }\n                }\n            });\n\n            $.ajax({\n                type: \"POST\",\n                url: url_save_table_to_page,\n                dataType: 'json',\n                data: JSON.stringify({\n                    'tableObject': tableObject,\n                    'source': src,\n                    'classificationCode': getClassificationCode(),\n                    'customClassificationCode': getCustomClassificationCode(),\n                    'customClassification': getCustomObject(),\n                    'ethnicityValues': getEthnicityValues(table_data)\n                }),\n                contentType: 'application/json',\n                success: function () {\n                    location.reload();\n                }\n            });\n        }\n    }\n\n    function getTablePageSettings() {\n        // get the data\n        var tabbedData = $(\"#data_text_area\").val();\n        return {\n            'data': textToData(tabbedData),\n            'preset': getClassificationCode(),\n            'custom': getCustomObject(),\n            'tableOptions': getTableTypeOptions(),\n            'tableValues': getTableValues(),\n        }\n    }\n\n    function getTableTypeOptions() {\n        if (getIsSimpleData(table_data)) {\n            return {};\n        }\n        else {\n            var dataStyle = $('#complex-table__data-style').val();\n\n            var selection = dataStyle === 'ethnicity_as_row' ? $('#ethnicity-as-row__columns').val() : $('#ethnicity-as-column__rows').val();\n            var order = dataStyle === 'ethnicity_as_row' ? $('#ethnicity-as-row__column-order').val() : $('#ethnicity-as-column__row-order').val();\n\n            return {\n                'data_style': $('#complex-table__data-style').val(),\n                'selection': selection,\n                'order': order,\n            }\n        }\n    }\n\n    function getTableValues() {\n        return {\n            'table_title': $('#table_title').val(),\n            'table_column_1': $('#table_column_1').val(),\n            'table_column_1_name': $('#table_column_1_name').val(),\n            'table_column_2': $('#table_column_2').val(),\n            'table_column_2_name': $('#table_column_2_name').val(),\n            'table_column_3': $('#table_column_3').val(),\n            'table_column_3_name': $('#table_column_3_name').val(),\n            'table_column_4': $('#table_column_4').val(),\n            'table_column_4_name': $('#table_column_4_name').val(),\n            'table_column_5': $('#table_column_5').val(),\n            'table_column_5_name': $('#table_column_5_name').val(),\n            'table_index_column_name': $('#index_column_name').val(),\n        }\n    }\n\n    function getClassificationCode() {\n        return $('#ethnicity_settings').val();\n    }\n\n    function getCustomClassificationCode() {\n        return $('#custom_classification__selector').val();\n    }\n\n    function getCustomHasParents() {\n        return $('#custom_classification__has_parents').prop('checked');\n    }\n\n    function getCustomHasAll() {\n        return $('#custom_classification__has_all').prop('checked');\n    }\n\n    function getCustomHasUnknown() {\n        return $('#custom_classification__has_unknown').prop('checked');\n    }\n\n    function getCustomObject() {\n        return {\n            'code': getCustomClassificationCode(),\n            'hasParents': getCustomHasParents(),\n            'hasAll': getCustomHasAll(),\n            'hasUnknown': getCustomHasUnknown()\n        }\n    }\n\n    function notNullOrNone(val) {  // We ingest some weird/inconsistent data from table builder v1 so this check helps prevent errors.\n        return val !== null & val != 'none'\n    }\n\n    function buildTableColumns() {\n        var columns = []\n        $('.column_option_picker').each(function (idx) {\n            if (notNullOrNone($(this).val())) {\n                columns.push($(this).val());\n            }\n            ;\n        });\n        return columns\n    }\n\n    function buildEthnicityByRowColumns() {\n        var columns = [$('#ethnicity-as-row__columns').val()]\n        if (notNullOrNone($('#ethnicity-as-row__column-order').val())) {\n            columns.push($('#ethnicity-as-row__column-order').val())\n        }\n        return columns\n    }\n\n    function buildEthnicityByColumnColumns() {\n        var columns = [$('#ethnicity-as-column__rows').val()]\n        if (notNullOrNone($('#ethnicity-as-column__row-order').val())) {\n            columns.push($('#ethnicity-as-column__row-order').val())\n        }\n        return columns\n    }\n\n    // This function examines the HTML page and returns an array of headings for columns\n    // being used.\n    //\n    // Note that a column may have no header, and that this is represented by a empty string,\n    // eg ['']. This is important as the length of this array is also used to determine the\n    // number of columns in use.\n    function buildTableColumnNames() {\n        var columns = []\n\n        $('.column_option_picker').each(function (index) {\n\n            if ($(this).val() !== 'none') {\n                columns.push($('.column_option_picker_name')[index].value)\n            }\n\n        })\n\n        return columns\n    }\n\n\n    function innerBuildTableObject() {\n        var tableObject = null;\n        var classification = getClassificationById($('#ethnicity_settings').val());\n        if (getIsSimpleData(table_data)) {\n            tableObject = buildTableObject(buildDataWithClassifications(classification, table_data, buildTableColumns()),\n                $('#table_title').val(),\n                '',\n                '',\n                'Ethnicity',\n                'Ethnicity-parent',\n                '[None]',\n                'Ethnicity-order',\n                buildTableColumns(),\n                buildTableColumnNames(),\n                $('#index_column_name').val(),\n                '[None]');\n        } else {\n            if ($('#complex-table__data-style').val() === 'ethnicity_as_row') {\n                var all_table_columns = buildTableColumns().concat(buildEthnicityByRowColumns());\n                tableObject = buildTableObject(buildDataWithClassifications(classification, table_data, all_table_columns),\n                    $('#table_title').val(),\n                    '',\n                    '',\n                    'Ethnicity',\n                    'Ethnicity-parent',\n                    $('#ethnicity-as-row__columns').val(),\n                    'Ethnicity-order',\n                    buildTableColumns(),\n                    buildTableColumnNames(),\n                    $('#index_column_name').val(),\n                    $('#ethnicity-as-row__column-order').val());\n            } else {\n                var all_table_columns = buildTableColumns().concat(buildEthnicityByColumnColumns());\n                tableObject = buildTableObject(buildDataWithClassifications(classification, table_data, all_table_columns),\n                    $('#table_title').val(),\n                    '',\n                    '',\n                    $('#ethnicity-as-column__rows').val(),\n                    '',\n                    'Ethnicity',\n                    $('#ethnicity-as-column__row-order').val(),\n                    buildTableColumns(),\n                    buildTableColumnNames(),\n                    $('#index_column_name').val(),\n                    'Ethnicity-order');\n            }\n        }\n        return tableObject;\n    }\n\n    function buildDataWithClassifications(classification, data, columns) {\n        var rows = [['Ethnicity', 'Ethnicity-parent', 'Ethnicity-order'].concat(columns)];\n\n        var body = _.clone(data);\n        var headers = body.shift();\n        var lowHeaders = _.map(headers, function (header) {\n            return header.toLowerCase().trim()\n        });\n        var indices = _.map(columns, function (col) {\n            var lowCol = col.toLowerCase().trim();\n            return lowHeaders.indexOf(lowCol);\n        });\n\n        for (var r in classification['data']) {\n            var item = classification['data'][r];\n            var row = [item['display_value'], item['parent'], item['order']];\n            row = row.concat(_.map(indices, function (index) {\n                return index === -1 ? '' : body[r][index]\n            }));\n            rows = rows.concat([row])\n        }\n\n        return rows;\n    }\n\n    function getClassificationById(classification_id) {\n        for (c in classifications) {\n            if (classifications[c].classification.id === classification_id) {\n                return classifications[c];\n            }\n        }\n        return null;\n    }\n\n\n    /*\n        EVENT HANDLERS\n    */\n    // Switch TABLE_OPTIONS panels\n    $('#ethnicity_settings').change(function() {\n        showHideCustomEthnicityPanel()\n        preview()\n    });\n    $('#custom_classification__selector').change(preview);\n\n    function selectClassification(classification) {\n        $('#ethnicity_settings').val(classification);\n    }\n\n    function selectCustomValues(customObject) {\n        selectCustomClassification(customObject['code'])\n        selectCustomHasParents(customObject['hasParents'])\n        selectCustomHasAll(customObject['hasAll'])\n        selectCustomHasUnknown(customObject['hasUnknown'])\n    }\n\n    function selectCustomClassification(customClassification) {\n        $('#custom_classification__selector').val(customClassification)\n    }\n\n    function selectCustomHasParents(customValue) {\n           $('#custom_classification__has_parents').prop('checked', customValue)\n    }\n\n    function selectCustomHasUnknown(customValue) {\n            $('#custom_classification__has_unknown').prop('checked', customValue)\n    }\n\n    function selectCustomHasAll(customValue) {\n            $('#custom_classification__has_all').prop('checked', customValue)\n    }\n\n    /*\n        TABLE PANEL events\n    */\n\n    // COMPLEX TABLE events\n    $('#complex-table__data-style').change(function () {\n        selectDataStyle();\n        modifyIndexColumnNameAndPreview();\n    });\n    $('#ethnicity-as-row__columns').change(function () {\n        setColumnOrdering();\n        modifyIndexColumnNameAndPreview();\n    });\n    $('#ethnicity-as-row__column-order').change(preview);\n    $('#ethnicity-as-column__rows').change(function () {\n        setRowOrdering();\n        modifyIndexColumnNameAndPreview();\n    });\n    $('#ethnicity-as-column__row-order').change(preview);\n\n    $('#grouped-bar__bar_order').change(preview);\n    $('#grouped-bar__groups_order').change(preview);\n\n    $('#table_column_1_name').change(preview);\n    $('#table_column_1').change(dataColumnChange);\n    $('#table_column_2_name').change(preview);\n    $('#table_column_2').change(dataColumnChange);\n    $('#table_column_3_name').change(preview);\n    $('#table_column_3').change(dataColumnChange);\n    $('#table_column_4_name').change(preview);\n    $('#table_column_4').change(dataColumnChange);\n    $('#table_column_5_name').change(preview);\n    $('#table_column_5').change(dataColumnChange);\n\n    $('#index_column_name').change(preview);\n\n    function selectDataStyle() {\n        if ($('#complex-table__data-style').val() === \"ethnicity_as_row\") {\n            document.getElementById('complex-table__ethnicity-is-row').classList.remove('hidden')\n            document.getElementById('complex-table__ethnicity-is-column').classList.add('hidden')\n        } else {\n            document.getElementById('complex-table__ethnicity-is-row').classList.add('hidden')\n            document.getElementById('complex-table__ethnicity-is-column').classList.remove('hidden')\n        }\n    }\n\n\n    // Show-hide NUMBER-FORMAT__OTHER panel\n    $('#number_format').change(function () {\n        if ($(this).val() === 'other') {\n            document.getElementById('other_number_format').classList.remove('hidden')\n        } else {\n            document.getElementById('other_number_format').classList.add('hidden')\n        }\n        preview();\n    });\n\n    function modifyIndexColumnNameAndPreview(evt) {\n        var indexColumnName = $('#index_column_name').val()\n        var headers = table_data[0]\n\n        // If index_column_name has not been modified change if possible\n        if (headers.indexOf(indexColumnName) >= 0 || indexColumnName === unselectedOptionString) {\n            if ($('#complex-table__data-style').val() === \"ethnicity_as_column\") {\n                $('#index_column_name').val($('#ethnicity-as-column__rows').val())\n            } else {\n                $('#index_column_name').val('Ethnicity')\n            }\n        }\n\n        preview(evt)\n    }\n\n    function setRowOrdering(evt) {\n        $('#ethnicity-as-column__row-order').val($('#ethnicity-as-column__rows').val())\n    }\n\n    function setColumnOrdering(evt) {\n        $('#ethnicity-as-row__column-order').val($('#ethnicity-as-row__columns').val())\n    }\n\n    function initialiseForm() {\n        if (settings.data) {\n            var data_text = _.map(settings.data, function (d) {\n                return d.join('\\t')\n            }).join('\\n');\n            $('#data_text_area').val(data_text);\n\n            handleNewData(function () {\n                document.getElementById('data-panel').classList.add('hidden')\n                document.getElementById('edit-panel').classList.remove('hidden')\n                setupTablebuilderWithSettings(settings);\n                preview()\n            })\n        }\n    };\n\n    function setupTablebuilderWithSettings(settings) {\n        if (settings.preset) {\n            selectClassification(settings.preset);\n        }\n        if (settings.custom) {\n            selectCustomValues(settings.custom)\n        }\n\n        showHideCustomEthnicityPanel()\n\n        $('#table_title').val(settings.tableValues.table_title);\n        document.getElementById('table_title').dispatchEvent(new Event(\"input\"));\n\n        $('#complex-table__data-style').val(settings.tableOptions.data_style);\n\n        /*\n        If a table has no explicit row ordering, there are some circumstances in which the live table can have data cells\n        transposed - resulting in an inaccurate table. We will prevent this by enforcing an explicit row order. If one\n        hasn't been provided previously, we'll assume the table should be sorted (alphabetically) by the current\n        row/column selection.\n        https://trello.com/c/mrtsskDU/1103\n        */\n        if (settings.tableOptions.order == NONE_VALUE) {\n            settings.tableOptions.order = settings.tableOptions.selection\n        }\n\n        if (settings.tableOptions.data_style === 'ethnicity_as_row') {\n            $('#ethnicity-as-row__columns').val(settings.tableOptions.selection);\n            $('#ethnicity-as-row__column-order').val(settings.tableOptions.order);\n        } else {\n            $('#ethnicity-as-column__rows').val(settings.tableOptions.selection);\n            $('#ethnicity-as-column__row-order').val(settings.tableOptions.order);\n        }\n\n        selectDataStyle();\n\n        $('#table_column_1').val(settings.tableValues.table_column_1);\n        $('#table_column_1_name').val(settings.tableValues.table_column_1_name);\n        $('#table_column_2').val(settings.tableValues.table_column_2);\n        $('#table_column_2_name').val(settings.tableValues.table_column_2_name);\n        $('#table_column_3').val(settings.tableValues.table_column_3);\n        $('#table_column_3_name').val(settings.tableValues.table_column_3_name);\n        $('#table_column_4').val(settings.tableValues.table_column_4);\n        $('#table_column_4_name').val(settings.tableValues.table_column_4_name);\n        $('#table_column_5').val(settings.tableValues.table_column_5);\n        $('#table_column_5_name').val(settings.tableValues.table_column_5_name);\n\n        $('#index_column_name').val(settings.tableValues.table_index_column_name);\n    }\n\n    initialiseForm();\n});\n\n/*\n Custom number format is far more complicated than it needs to be\n However it is viable to just use this function to grab it until it becomes a problem\n*/\n\nfunction getNumberFormat() {\n    var format = $('#number_format').val();\n    if (format === 'none') {\n        return {'multiplier': 1.0, 'prefix': '', 'suffix': '', 'min': '', 'max': ''}\n    } else if (format === 'percent') {\n        return {'multiplier': 1.0, 'prefix': '', 'suffix': '%', 'min': 0.0, 'max': 100.0}\n    } else if (format === 'other') {\n        return {\n            'multiplier': 1.0,\n            'prefix': $('#number_format_prefix').val(),\n            'suffix': $('#number_format_suffix').val(),\n            'min': $('#number_format_min').val(),\n            'max': $('#number_format_max').val()\n        }\n    }\n}\n\nfunction getTips() {\n\n    // 1. Basics\n    var basicErrors = validateTable(table_data);\n    if (basicErrors.length !== 0) {\n        return basicErrors;\n    }\n\n    // 2. Required fields\n    var missingFields = checkRequiredFields();\n    if (missingFields.length !== 0) {\n        return missingFields\n    }\n\n    // 3. Data errors\n    var ethnicityColumn = getEthnicityColumnHeader();\n    var secondaryColumn = getSecondaryColumnHeader();\n\n    var dataErrors = validateData(table_data, ethnicityColumn, secondaryColumn);\n    return dataErrors;\n}\n\nvar MISSING_FIELD_ERROR = 'Missing field error';\n\nfunction checkRequiredFields() {\n    if ($('#ethnicity_settings').val() === 'custom' && $('#custom_classification__selector').val() === 'Please select') {\n        return [{ 'errorType': MISSING_FIELD_ERROR, 'field': 'custom_classification__selector' }]\n    }\n\n    if (getIsSimpleData(table_data) === false) {\n        if ($('#complex-table__data-style').val() === 'ethnicity_as_row') {\n            if ($('#ethnicity-as-row__columns').val() === unselectedOptionString) {\n                return [{ 'errorType': MISSING_FIELD_ERROR, 'field': 'ethnicity-as-row__columns' }]\n            };\n            if ($('#ethnicity-as-row__column-order').val() === unselectedOptionString) {\n                return [{ 'errorType': MISSING_FIELD_ERROR, 'field': 'ethnicity-as-row__column-order' }]\n            };\n        } else {\n            if ($('#ethnicity-as-column__rows').val() === unselectedOptionString) {\n                return [{ 'errorType': MISSING_FIELD_ERROR, 'field': 'ethnicity-as-column__rows' }]\n            };\n            if ($('#ethnicity-as-column__row-order').val() === unselectedOptionString) {\n                return [{ 'errorType': MISSING_FIELD_ERROR, 'field': 'ethnicity-as-column__row-order' }]\n            };\n        }\n    }\n\n    if ($('#table_column_1').val() === unselectedOptionString) {\n        return [{'errorType': MISSING_FIELD_ERROR, 'field': 'table_column_1'}]\n    }\n\n    return [];\n}\n\nfunction getEthnicityColumnHeader() {\n    for (var i in table_data[0]) {\n        var lower = table_data[0][i].toLowerCase();\n        if (lower.search('ethnic') >= 0) {\n            return table_data[0][i]\n        }\n    }\n    return null\n}\n\nfunction getSecondaryColumnHeader() {\n    if (getIsSimpleData(table_data)) {\n        return null;\n    } else {\n        if ($('#complex-table__data-style').val() === 'ethnicity_as_row') {\n            return $('#ethnicity-as-row__columns').val()\n        } else {\n            return $('#ethnicity-as-column__rows').val()\n        }\n    }\n}\n\n/*\n    Helper for selenium tests\n*/\n\nfunction pasteJson(json) {\n    var data_text_area = document.getElementById('data_text_area');\n\n    data_text_area.value = _.map(json, function (row) {\n        return row.join('\\t');\n    }).join('\\n');\n    data_text_area.dispatchEvent(new Event(\"keyup\"));\n}\n","/**\n * Created by Tom.Ridd on 25/02/2018.\n\n rd-builder provides common functions that are required by both the chartbuilder and tablebuilder screens\n\n specifically\n - validate that data does not have multiple rows that correspond to a single data point\n - validate that data has coverage of every data point\n - provide useful error messages when data is invalid\n\n */\n\n// Forms of data error\nvar DATA_ERROR_DUPLICATION = \"duplication\";\nvar DATA_ERROR_MISSING_DATA = \"missing data\";\nvar DATA_ERROR_SETTINGS_ERROR = \"settings\";\nvar DATA_ERROR_COMPLEX_DATA = \"complex data\";\n\n\n// ---------------------------------------------------------------------------\n// PUBLIC\n// ---------------------------------------------------------------------------\n\n\nfunction validateData(data, categoryColumn, groupColumn) {\n    var errors = [];\n    var dataRows = _.clone(data);\n    var headerRow = dataRows.shift();\n    var lowerHeaderRow = _.map(headerRow, function (m) {\n        return m.trim().toLowerCase()\n    })\n\n    var categoryIndex = index_of_column_named(lowerHeaderRow, categoryColumn);\n    if (categoryIndex === null) {\n        return [{\n            'error': 'could not find data column',\n            'column': categoryColumn,\n            'errorType': DATA_ERROR_SETTINGS_ERROR\n        }]\n    }\n    if (groupColumn !== null) {\n        var groupIndex = index_of_column_named(lowerHeaderRow, groupColumn);\n        if (groupIndex === null) {\n            return [{\n                'error': 'could not find data column',\n                'column': groupColumn,\n                'errorType': DATA_ERROR_SETTINGS_ERROR\n            }]\n        } else {\n            return validateGroupedData(dataRows, categoryIndex, groupIndex, categoryColumn, groupColumn)\n        }\n    } else {\n        return validateSimpleData(dataRows, categoryIndex, categoryColumn)\n    }\n}\n\nfunction validateDataDuplicatesOnly(data, categoryColumn, groupColumn) {\n    var errors = [];\n    var dataRows = _.clone(data);\n    var headerRow = dataRows.shift();\n    var lowerHeaderRow = _.map(headerRow, function (m) {\n        return m.trim().toLowerCase();\n    });\n    var categoryIndex = index_of_column_named(lowerHeaderRow, categoryColumn);\n\n    if (categoryIndex === null) {\n        return [{'error': 'could not find data column', 'column': categoryColumn}]\n    }\n    if (groupColumn !== null) {\n        var groupIndex = index_of_column_named(lowerHeaderRow, groupColumn);\n\n        if (groupIndex === null) {\n            return [{'error': 'could not find data column', 'column': groupColumn}]\n        } else {\n            return validateGroupedDataDuplicates(dataRows, categoryIndex, groupIndex)\n        }\n    } else {\n        return validateSimpleData(dataRows, categoryIndex)\n    }\n}\n\n\n// ---------------------------------------------------------------------------\n// SIMPLE DATA (not cross tab, multiseries, panel, etc...)\n// ---------------------------------------------------------------------------\n\nfunction validateSimpleData(data, categoryIndex, categoryColumn) {\n    var duplicateErrors = [];\n\n    var uniqueCategories = _.uniq(_.map(data, function (row) {\n        return row[categoryIndex];\n    }));\n\n    if (uniqueCategories.length === data.length) {\n        return [];\n    } else if (data.length % uniqueCategories.length === 0) {\n        return [{'errorType': DATA_ERROR_COMPLEX_DATA}]\n    } else {\n        var dict = {};\n        _.forEach(data, function (row) {\n            var value = row[categoryIndex];\n            if (value in dict) {\n                // wrap in if to make sure we don't add multiple error messages\n                if (dict[value] !== 'added to errors') {\n                    duplicateErrors.push({\n                        'error': 'duplicate data',\n                        'category': value,\n                        'categoryColumn': categoryColumn,\n                        'errorType': DATA_ERROR_DUPLICATION\n                    });\n                    dict[value] = 'added to errors'\n                }\n            } else {\n                dict[value] = 'value in dict'\n            }\n        });\n\n        return duplicateErrors;\n    }\n\n}\n\n\n// ---------------------------------------------------------------------------\n// GROUPED DATA VALIDATION (cross tab, multiseries, panel, etc...)\n// ---------------------------------------------------------------------------\n\nfunction validateGroupedData(data, categoryIndex, groupIndex, categoryColumn, groupColumn) {\n    var completeErrors = validateGroupedDataCompleteness(data, categoryIndex, groupIndex, categoryColumn, groupColumn);\n    var duplicateErrors = validateGroupedDataDuplicates(data, categoryIndex, groupIndex, categoryColumn, groupColumn);\n\n    return completeErrors.concat(duplicateErrors);\n}\n\nfunction validateGroupedDataCompleteness(data, categoryIndex, groupIndex, categoryColumn, groupColumn) {\n    var rowItems = _.uniq(_.map(data, function (item) {\n        return item[categoryIndex];\n    }));\n    var columnItems = _.uniq(_.map(data, function (item) {\n        return item[groupIndex];\n    }));\n    var errors = [];\n\n    var mapOfPairs = _.object(_.map(rowItems, function (item) {\n        return [item, _.map(_.filter(data, function (row) {\n            return row[categoryIndex] === item\n        }), function (row) {\n            return row[groupIndex];\n        })];\n    }));\n\n    _.forEach(rowItems, function (row) {\n        _.forEach(columnItems, function (col) {\n            if (!_.contains(mapOfPairs[row], col)) {\n                errors.push({\n                    'error': 'missing data',\n                    'category': row,\n                    'group': col,\n                    'categoryColumn': categoryColumn,\n                    'groupColumn': groupColumn,\n                    'errorType': DATA_ERROR_MISSING_DATA\n                })\n            }\n        })\n    });\n\n    return errors\n}\n\nfunction validateGroupedDataDuplicates(data, categoryIndex, groupIndex, categoryColumn, groupColumn) {\n    var errors = [];\n\n    var groupValuesUsedByCategory = {};\n    _.forEach(data, function (row) {\n        var categoryValue = row[categoryIndex];\n        var groupValue = row[groupIndex];\n        if (categoryValue in groupValuesUsedByCategory) {\n            if (groupValue in groupValuesUsedByCategory[categoryValue]) {\n                errors.push({\n                    'error': 'duplicate data',\n                    'category': row[categoryIndex],\n                    'group': row[groupIndex],\n                    'categoryColumn': categoryColumn,\n                    'groupColumn': groupColumn,\n                    'errorType': DATA_ERROR_DUPLICATION\n                })\n            } else {\n                groupValuesUsedByCategory[categoryValue][groupValue] = 1;\n            }\n        } else {\n            groupValuesUsedByCategory[categoryValue] = {};\n            groupValuesUsedByCategory[categoryValue][groupValue] = 1;\n        }\n    });\n\n    return errors;\n}\n\n\n// ---------------------------------------------------------------------------\n// ERROR REPORTING\n// ---------------------------------------------------------------------------\n\nfunction errorDescription(error) {\n    switch (error.errorType) {\n        case DATA_ERROR_SETTINGS_ERROR:\n            return \"Column '\" + error.column + \"' not found\";\n\n        case DATA_ERROR_MISSING_DATA:\n            return \"The data is missing a row for \" + error.categoryColumn + \" = '\" + error.category + \"' and \" + error.groupColumn + \" = '\" + error.group + \"'\"\n\n        case DATA_ERROR_DUPLICATION:\n            if ('group' in error) {\n                return \"The data has duplicate entries for the rows with \" + error.categoryColumn + \" = '\" + error.category + \"' and \" + error.groupColumn + \" = '\" + error.group + \"'\"\n            } else {\n                return \"The data has duplicate entries for \" + error.categoryColumn + \" = '\" + error.category + \"'\"\n            }\n    }\n}\n\nfunction errorResolutionHint(error) {\n    switch (error.errorType) {\n        case DATA_ERROR_SETTINGS_ERROR:\n            return \"Make sure the column values selected for this table are valid\";\n\n        case DATA_ERROR_MISSING_DATA:\n            return \"Add rows to your source spreadsheet and try again\";\n\n        case DATA_ERROR_DUPLICATION:\n            return \"Remove data rows in your source spreadsheet and try again\"\n\n    }\n}\n\n\n// If we're running under Node - required for testing\nif (typeof exports !== 'undefined') {\n    var _ = require('../charts/vendor/underscore-min');\n    var dataTools = require('../charts/rd-data-tools');\n    var index_of_column_named = dataTools.index_of_column_named;\n\n    exports.validateSimpleData = validateSimpleData;\n    exports.validateGroupedData = validateGroupedData;\n    exports.validateData = validateData;\n    exports.DATA_ERROR_DUPLICATION = DATA_ERROR_DUPLICATION;\n    exports.DATA_ERROR_MISSING_DATA = DATA_ERROR_MISSING_DATA;\n    exports.DATA_ERROR_COMPLEX_DATA = DATA_ERROR_COMPLEX_DATA;\n    exports.DATA_ERROR_SETTINGS_ERROR = DATA_ERROR_SETTINGS_ERROR;\n}\n","/**\n * Created by Tom.Ridd on 08/05/2017.\n */\n\nfunction filterData(data, filter) {\n\n    var indexFilter = textFilterToIndexFilter(data, filter);\n    return applyFilter(data, indexFilter);\n}\n\nfunction numerateColumns(data, columns) {\n    _.forEach(columns, function (column) {\n        numerateColumn(data, column);\n    });\n}\n\nfunction numerateColumn(data, column) {\n    var index = data[0].indexOf(column);\n    for (row = 1; row < data.length; row++) {\n        row[index] = row[index].toFloat();\n    }\n}\n\nfunction textFilterToIndexFilter(data, textFilter) {\n    var indexFilter = {};\n    var headers = data[0];\n\n    for (var key in textFilter) {\n        var i = headers.indexOf(key);\n        indexFilter[i] = textFilter[key];\n    }\n\n    return indexFilter;\n}\n\nfunction applyFilter(data, indexFilter) {\n    var data2 = _.clone(data);\n\n    var headerRow = data2.shift();\n    var filteredRows = [];\n\n    for (var d in data2) {\n        var datum = data2[d];\n        if (itemPassesFilter(datum, indexFilter)) {\n            filteredRows.push(datum);\n        }\n    }\n\n    filteredRows.unshift(headerRow);\n    return filteredRows;\n}\n\nfunction itemPassesFilter(item, filter) {\n    if (item[0] === '') { return false; }\n\n    for (var index in filter) {\n        if (item[index] !== filter[index]) {\n            return false;\n        }\n    }\n    return true;\n}\n\nfunction formatNumber(numStr) {\n    var number = numStr.replaceAll(\"%\", \"\");\n    var formatted = (number * 1).toLocaleString(\"en-uk\");\n    if (formatted === \"NaN\") {\n        return number;\n    } else {\n        return formatted;\n    }\n}\n\n\n\nfunction formatNumberWithDecimalPlaces(value, dp) {\n\n    var number = \"\" + value;\n\n    // Only do formatting if the string contains some digits\n    if (number.match(/\\d/)) {\n        try {\n            number = number.replace(\"%\", \"\");\n        } finally {\n            var formatted = (number * 1).toLocaleString(\"en-uk\", { minimumFractionDigits: dp, maximumFractionDigits: dp });\n            if (formatted !== \"NaN\") {\n                return formatted;\n            }\n        }\n    }\n    return number;\n}\n\nfunction seriesDecimalPlaces(series) {\n    var maxDp = 0;\n    for (var s in series) {\n        var dp = decimalPlaces(series[s]);\n        if (dp > maxDp) {\n            maxDp = dp;\n        }\n    }\n    return maxDp;\n}\n\nfunction seriesCouldBeYear(series) {\n    for (var s in series) {\n        var val = series[s];\n        if (decimalPlaces(val) > 0 || val < 1950 || val > 2050) {\n            return false;\n        }\n    }\n    return true;\n}\n\nfunction decimalPlaces(valueStr) {\n\n    // We only want to match digits following the first\n    // full stop, ignoring any trailing zeros.\n    var decimalPlacesRegex = /\\.(\\d*[1-9])/;\n\n    var numStr = valueStr ? String(valueStr) : \"\";\n\n    var decimalFigureMatch = numStr.match(decimalPlacesRegex);\n\n    if (decimalFigureMatch) {\n        return decimalFigureMatch[1].length\n    } else {\n        return 0\n    }\n}\n\nfunction uniqueDataInColumn(data, index) {\n    var values = _.map(data.slice(start = 0), function (item) {\n        return item[index];\n    });\n    return _.uniq(values).sort();\n}\n\nfunction uniqueDataInColumnOrdered(data, index, order_column) {\n    // Sort by the specified column\n    var sorted = _.sortBy(data, function (item) {\n        return item[order_column];\n    });\n    // Pull out unique items\n    var values = _.map(sorted, function (item) { return item[index]; });\n    return _.uniq(values);\n}\n\nfunction uniqueDataInColumnMaintainOrder(data, index) {\n    var values = [];\n    var used = {};\n    _.forEach(data, function (item) {\n        if (!(item[index] in used)) {\n            values.push(item[index]);\n            used[item[index]] = 1;\n        }\n    });\n    return values;\n}\n\n\nfunction textToData(textData) {\n    var delimiter = '\\t'\n    // Super-undocumented feature that means users could enter pipe-delimited data rather than tab-delimited\n    if (textData.search(delimiter) < 0) {\n        delimiter = '|'\n    }\n\n    splitLineAndTrimEachItem = function (line) {\n        return _.map(line.split(delimiter), function (item) {return item.trim()});\n    }\n\n    var lines = textData.trim().split('\\n');\n    return _.map(lines, splitLineAndTrimEachItem);\n}\n\nvar ETHNICITY_ERROR = 'Ethnicity column error';\nvar VALUE_ERROR = 'Value column error';\nvar RECTANGLE_ERROR = 'Data table error';\n\nfunction validateChart(data) {\n    var errors = [];\n    if (hasHeader('ethnic', data) === false) { errors.push({ 'errorType': ETHNICITY_ERROR }); }\n    if (hasHeader('value', data) === false) { errors.push({ 'errorType': VALUE_ERROR }); }\n    if (isRectangular(data) === false) { errors.push({ 'errorType': RECTANGLE_ERROR }); }\n\n    return errors;\n}\n\nfunction validateTable(data) {\n    var errors = [];\n    if (hasHeader('ethnic', data) === false) { errors.push({ 'errorType': ETHNICITY_ERROR }); }\n    return errors;\n}\n\nfunction hasHeader(header, data) {\n    var headers = data[0];\n    var found = false;\n    _.forEach(headers, function (str) {\n        var lower = str.toLowerCase();\n        if (lower.search(header) >= 0) { found = true; }\n    });\n    return found;\n}\n\nfunction isRectangular(data) {\n    var size = data[0].length;\n    for (var i = 1; i < data.length; i++) {\n        if (data[i].length !== size) { return false; }\n    }\n    return true;\n}\n\nfunction nonNumericData(data, columns) {\n    var nonNumeric = [];\n    var values = data.slice(1);\n\n    _.forEach(values, function (row) {\n        _.forEach(columns, function (column) {\n            var item = row[column];\n            if (isNaN(item)) {\n                nonNumeric.push(item);\n            }\n        });\n    });\n    return nonNumeric;\n}\n\nfunction index_of_column_named(headers, column) {\n    if (!column || column === '') {\n        return null\n    } else {\n        var index = headers.indexOf(column.trim().toLowerCase());\n        if (index === -1) {\n            return null;\n        } else {\n            return index;\n        }\n    }\n}\n\n// If we're running under Node - required for testing\nif (typeof exports !== 'undefined') {\n    var _ = require('./vendor/underscore-min');\n\n    exports.hasHeader = hasHeader;\n    exports.decimalPlaces = decimalPlaces;\n    exports.seriesDecimalPlaces = seriesDecimalPlaces;\n    exports.seriesCouldBeYear = seriesCouldBeYear;\n    exports.formatNumberWithDecimalPlaces = formatNumberWithDecimalPlaces;\n\n    exports.uniqueDataInColumn = uniqueDataInColumn;\n    exports.uniqueDataInColumnOrdered = uniqueDataInColumnOrdered;\n    exports.uniqueDataInColumnMaintainOrder = uniqueDataInColumnMaintainOrder;\n\n    exports.validateChart = validateChart;\n    exports.textToData = textToData;\n\n    exports.nonNumericData = nonNumericData;\n\n    exports.index_of_column_named = index_of_column_named;\n\n    exports.ETHNICITY_ERROR = ETHNICITY_ERROR;\n    exports.VALUE_ERROR = VALUE_ERROR;\n}\n"],"sourceRoot":"../src"}